C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN ..\obj\system.obj
COMPILER INVOKED BY: D:\Program Files\KEILC51\files\C51\BIN\C51.EXE ..\..\user\system.c LARGE BROWSE DEBUG OBJECTEXTEND 
                    -LISTINCLUDE SYMBOLS PRINT(.\system.lst) TABS(2) OBJECT(..\obj\system.obj)

line level    source

   1          /**
   2            ******************************************************************************
   3            * @file    
   4            * @author  
   5            * @version 
   6            * @date   
   7            * @brief    
   8            ******************************************************************************  
   9            * 
  10            * 
  11            ******************************************************************************
  12            */
  13          /*-- includes ----------------------------------------------------------------*/
  14          #include "./system.h"
   1      =1  /**
   2      =1    ******************************************************************************
   3      =1    * @file    
   4      =1    * @author  
   5      =1    * @version 
   6      =1    * @date   
   7      =1    * @brief   
   8      =1    ******************************************************************************  
   9      =1    * 
  10      =1    * 
  11      =1    ******************************************************************************
  12      =1    */
  13      =1  #ifndef    SYSTEM_H
  14      =1  #define    SYSTEM_H
  15      =1  
  16      =1  
  17      =1  /*-- includes  ---------------------------------------------------------------*/
  18      =1  #include <stdio.h>
   1      =2  /*--------------------------------------------------------------------------
   2      =2  STDIO.H
   3      =2  
   4      =2  Prototypes for standard I/O functions.
   5      =2  Copyright (c) 1988-2002 Keil Elektronik GmbH and Keil Software, Inc.
   6      =2  All rights reserved.
   7      =2  --------------------------------------------------------------------------*/
   8      =2  
   9      =2  #ifndef __STDIO_H__
  10      =2  #define __STDIO_H__
  11      =2  
  12      =2  #ifndef EOF
  13      =2   #define EOF -1
  14      =2  #endif
  15      =2  
  16      =2  #ifndef NULL
  17      =2   #define NULL ((void *) 0)
  18      =2  #endif
  19      =2  
  20      =2  #ifndef _SIZE_T
  21      =2   #define _SIZE_T
  22      =2   typedef unsigned int size_t;
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 2   

  23      =2  #endif
  24      =2  
  25      =2  #pragma SAVE
  26      =2  #pragma REGPARMS
  27      =2  extern char _getkey (void);
  28      =2  extern char getchar (void);
  29      =2  extern char ungetchar (char);
  30      =2  extern char putchar (char);
  31      =2  extern int printf   (const char *, ...);
  32      =2  extern int sprintf  (char *, const char *, ...);
  33      =2  extern int vprintf  (const char *, char *);
  34      =2  extern int vsprintf (char *, const char *, char *);
  35      =2  extern char *gets (char *, int n);
  36      =2  extern int scanf (const char *, ...);
  37      =2  extern int sscanf (char *, const char *, ...);
  38      =2  extern int puts (const char *);
  39      =2  
  40      =2  #pragma RESTORE
  41      =2  
  42      =2  #endif
  43      =2  
  19      =1  
  20      =1  #include "../includes/_sys_config.h"
   1      =2  /**
   2      =2    ******************************************************************************
   3      =2    * @file    
   4      =2    * @author  
   5      =2    * @version 
   6      =2    * @date   
   7      =2    * @brief   
   8      =2    ******************************************************************************  
   9      =2    * 
  10      =2    * 
  11      =2    ******************************************************************************
  12      =2    */
  13      =2  #ifndef    _SYS_CONFIG_H
  14      =2  #define    _SYS_CONFIG_H
  15      =2  
  16      =2  
  17      =2  /* C++ support */
  18      =2  #ifdef __cplusplus
           =2 extern "C" {
           =2 #endif
  21      =2  
  22      =2  
  23      =2  #include "./_sys_std.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef  _SYS_STD_H
  14      =3  #define  _SYS_STD_H
  15      =3  
  16      =3  
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 3   

  17      =3  /* C++支持 */
  18      =3  #ifdef __cplusplus
           =3 extern "C" {
           =3 #endif
  21      =3   
  22      =3  
  23      =3  
  24      =3  /*!< Signed integer types  */
  25      =3  typedef         signed char             s8_t;
  26      =3  typedef         signed int              s16_t;
  27      =3  typedef         signed long             s32_t;
  28      =3  
  29      =3  /*!< Unsigned integer types  */
  30      =3  typedef         unsigned char           u8_t;
  31      =3  typedef         unsigned int            u16_t;
  32      =3  typedef         unsigned long           u32_t;
  33      =3  
  34      =3  
  35      =3  
  36      =3  #define       XDATA    xdata
  37      =3  #define       IDATA    idata
  38      =3  #define       BDATA    bdata
  39      =3  #define       DATA     data
  40      =3  #define       CODE     code
  41      =3  
  42      =3  
  43      =3  /* 把宏参数变为一个字符串 */
  44      =3  #define     _STRING(x)                  #x
  45      =3  #define     STRING(x)                   _STRING(x)
  46      =3  
  47      =3  /* 把宏参数连接在一起 */
  48      =3  #define     _CONNECT_MACRO(x,y)         x##y
  49      =3  #define     CONNECT_MACRO(x,y)          _CONNECT_MACRO(x,y)
  50      =3  
  51      =3  
  52      =3  
  53      =3  /* 状态类型 */
  54      =3  typedef  enum
  55      =3  {
  56      =3    OPERATE_OK  = 0,
  57      =3    OPERATE_BUSY,
  58      =3    OPERATE_TIMEOUT,
  59      =3    OPERATE_FAIL,
  60      =3  }OpsStatus;
  61      =3  
  62      =3  
  63      =3  #ifndef  _IN_LINE_
  64      =3    #define  _IN_LINE_   inline
  65      =3  #endif
  66      =3  
  67      =3  #ifndef   BOOL
  68      =3    #define   BOOL      bool
  69      =3  #endif
  70      =3  
  71      =3  #ifndef   NULL
           =3   #define   NULL     (void*)0
           =3 #endif
  74      =3  
  75      =3  
  76      =3  #ifndef  TRUE
  77      =3    #define   TRUE    1
  78      =3  #endif
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 4   

  79      =3  
  80      =3  #ifndef  FALSE
  81      =3    #define   FALSE    0
  82      =3  #endif
  83      =3  
  84      =3  /* 纯虚函数关键字 */
  85      =3  #ifndef   VIRTUAL
  86      =3    #define   VIRTUAL
  87      =3  #endif
  88      =3  
  89      =3  
  90      =3  
  91      =3  
  92      =3  #ifdef __cplusplus
           =3 }
           =3 #endif
  95      =3  
  96      =3  #endif    /* _SYS_STD_H */
  97      =3  
  98      =3  /*------------------ end of file ---------------------------------------------*/
  24      =2  
  25      =2  
  26      =2  /*< Configure the watchdog function.  0: disable; 1:enable. >*/
  27      =2  #define     WDT_ENABLE                                 1
  28      =2  
  29      =2  /*< Log output configuration. 0: disable; 1:enable. >*/
  30      =2  #define     LOG_ENABLE                                 1
  31      =2  
  32      =2  /*< Console configuration. 0: disable; 1:enable. >*/
  33      =2  #define     CONSOLE_ENABLE                             0
  34      =2  
  35      =2  
  36      =2  
  37      =2  
  38      =2  /* C++ support */
  39      =2  #ifdef __cplusplus
           =2 }
           =2 #endif
  42      =2  
  43      =2  
  44      =2  #endif   /* _SYS_CONFIG_H */
  45      =2  
  46      =2  /*---------------------- end of file -----------------------------------------*/
  21      =1  #include "../mcu/hal_core.h"
   1      =2                                  /**
   2      =2    ******************************************************************************
   3      =2    * @file    
   4      =2    * @author  
   5      =2    * @version 
   6      =2    * @date   
   7      =2    * @brief   
   8      =2    ******************************************************************************  
   9      =2    * 
  10      =2    * 
  11      =2    ******************************************************************************
  12      =2    */
  13      =2  #ifndef    HAL_CORE_H
  14      =2  #define    HAL_CORE_H
  15      =2  
  16      =2  
  17      =2  /*-- includes  ---------------------------------------------------------------*/
  18      =2  #include "../includes/_sys_config.h"
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 5   

   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    _SYS_CONFIG_H
           =3 #define    _SYS_CONFIG_H
           =3 
           =3 
           =3 /* C++ support */
           =3 #ifdef __cplusplus
           =3 extern "C" {
           =3 #endif
           =3 
           =3 
           =3 #include "./_sys_std.h"
           =3 
           =3 
           =3 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =3 #define     WDT_ENABLE                                 1
           =3 
           =3 /*< Log output configuration. 0: disable; 1:enable. >*/
           =3 #define     LOG_ENABLE                                 1
           =3 
           =3 /*< Console configuration. 0: disable; 1:enable. >*/
           =3 #define     CONSOLE_ENABLE                             0
           =3 
           =3 
           =3 
           =3 
           =3 /* C++ support */
           =3 #ifdef __cplusplus
           =3 }
           =3 #endif
           =3 
           =3 
           =3 #endif   /* _SYS_CONFIG_H */
  45      =3  
  46      =3  /*---------------------- end of file -----------------------------------------*/
  19      =2  
  20      =2  #include "./hal_clk.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    HAL_CLK_H
  14      =3  #define    HAL_CLK_H
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 6   

  15      =3  
  16      =3  
  17      =3  /*-- includes  ---------------------------------------------------------------*/
  18      =3  #include "../includes/_sys_config.h"
   1      =4  /**
   2      =4    ******************************************************************************
   3      =4    * @file    
   4      =4    * @author  
   5      =4    * @version 
   6      =4    * @date   
   7      =4    * @brief   
   8      =4    ******************************************************************************  
   9      =4    * 
  10      =4    * 
  11      =4    ******************************************************************************
  12      =4    */
  13      =4  #ifndef    _SYS_CONFIG_H
           =4 #define    _SYS_CONFIG_H
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 extern "C" {
           =4 #endif
           =4 
           =4 
           =4 #include "./_sys_std.h"
           =4 
           =4 
           =4 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =4 #define     WDT_ENABLE                                 1
           =4 
           =4 /*< Log output configuration. 0: disable; 1:enable. >*/
           =4 #define     LOG_ENABLE                                 1
           =4 
           =4 /*< Console configuration. 0: disable; 1:enable. >*/
           =4 #define     CONSOLE_ENABLE                             0
           =4 
           =4 
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 }
           =4 #endif
           =4 
           =4 
           =4 #endif   /* _SYS_CONFIG_H */
  45      =4  
  46      =4  /*---------------------- end of file -----------------------------------------*/
  19      =3  
  20      =3  
  21      =3  
  22      =3  /*-- defined  ----------------------------------------------------------------*/
  23      =3  
  24      =3  
  25      =3  
  26      =3  /*-- functions  ---------------------------------------------------------------*/
  27      =3  extern   void    mcu_clk_init(u32_t freq);
  28      =3  
  29      =3  
  30      =3  #endif   /* HAL_CLK_H */
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 7   

  31      =3  
  32      =3  /*---------------------- end of file -----------------------------------------*/
  21      =2  #include "./hal_adc.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    HAL_ADC_H
  14      =3  #define    HAL_ADC_H
  15      =3  
  16      =3  
  17      =3  /*-- includes  ---------------------------------------------------------------*/
  18      =3  #include "../includes/_sys_config.h"
   1      =4  /**
   2      =4    ******************************************************************************
   3      =4    * @file    
   4      =4    * @author  
   5      =4    * @version 
   6      =4    * @date   
   7      =4    * @brief   
   8      =4    ******************************************************************************  
   9      =4    * 
  10      =4    * 
  11      =4    ******************************************************************************
  12      =4    */
  13      =4  #ifndef    _SYS_CONFIG_H
           =4 #define    _SYS_CONFIG_H
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 extern "C" {
           =4 #endif
           =4 
           =4 
           =4 #include "./_sys_std.h"
           =4 
           =4 
           =4 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =4 #define     WDT_ENABLE                                 1
           =4 
           =4 /*< Log output configuration. 0: disable; 1:enable. >*/
           =4 #define     LOG_ENABLE                                 1
           =4 
           =4 /*< Console configuration. 0: disable; 1:enable. >*/
           =4 #define     CONSOLE_ENABLE                             0
           =4 
           =4 
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 }
           =4 #endif
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 8   

           =4 
           =4 
           =4 #endif   /* _SYS_CONFIG_H */
  45      =4  
  46      =4  /*---------------------- end of file -----------------------------------------*/
  19      =3  
  20      =3  
  21      =3  
  22      =3  /*-- defined  ----------------------------------------------------------------*/
  23      =3  #define      ADC_FULL_SCALE         (u32_t)4095
  24      =3  
  25      =3  
  26      =3  typedef  enum
  27      =3  {
  28      =3    ADC_CH0 = (u8_t)0,
  29      =3    ADC_CH1,
  30      =3    ADC_CH2,
  31      =3    ADC_CH3,
  32      =3    ADC_CH4,
  33      =3    ADC_CH5,
  34      =3    ADC_CH6,
  35      =3    ADC_CH7,
  36      =3    ADC_BANDGAP,
  37      =3  }AdcChannelEnum;
  38      =3  
  39      =3  
  40      =3  
  41      =3  
  42      =3  /*-- functions  ---------------------------------------------------------------*/
  43      =3  extern   u32_t   mcu_adc_read_bandgap_volt(void);
  44      =3  extern   u32_t   mcu_adc_get(AdcChannelEnum ch);
  45      =3  
  46      =3  
  47      =3  
  48      =3  
  49      =3  #endif   /* HAL_ADC_H */
  50      =3  
  51      =3  /*---------------------- end of file -----------------------------------------*/
  22      =2  #include "./hal_gpio.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    HAL_GPIO_H
  14      =3  #define    HAL_GPIO_H
  15      =3  
  16      =3  
  17      =3  /*-- includes  ---------------------------------------------------------------*/
  18      =3  #include "../includes/_sys_config.h"
   1      =4  /**
   2      =4    ******************************************************************************
   3      =4    * @file    
   4      =4    * @author  
   5      =4    * @version 
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 9   

   6      =4    * @date   
   7      =4    * @brief   
   8      =4    ******************************************************************************  
   9      =4    * 
  10      =4    * 
  11      =4    ******************************************************************************
  12      =4    */
  13      =4  #ifndef    _SYS_CONFIG_H
           =4 #define    _SYS_CONFIG_H
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 extern "C" {
           =4 #endif
           =4 
           =4 
           =4 #include "./_sys_std.h"
           =4 
           =4 
           =4 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =4 #define     WDT_ENABLE                                 1
           =4 
           =4 /*< Log output configuration. 0: disable; 1:enable. >*/
           =4 #define     LOG_ENABLE                                 1
           =4 
           =4 /*< Console configuration. 0: disable; 1:enable. >*/
           =4 #define     CONSOLE_ENABLE                             0
           =4 
           =4 
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 }
           =4 #endif
           =4 
           =4 
           =4 #endif   /* _SYS_CONFIG_H */
  45      =4  
  46      =4  /*---------------------- end of file -----------------------------------------*/
  19      =3  
  20      =3  
  21      =3  
  22      =3  /*-- defined  ----------------------------------------------------------------*/
  23      =3  /*< IO defined. >*/
  24      =3  typedef  enum
  25      =3  {
  26      =3    PORT0 = 0,
  27      =3    PORT1,
  28      =3    PORT2,
  29      =3    PORT3,
  30      =3  }GpioPort;
  31      =3  
  32      =3  typedef  enum
  33      =3  {
  34      =3    PIN0 = 0,
  35      =3    PIN1,
  36      =3    PIN2,
  37      =3    PIN3,
  38      =3    PIN4,
  39      =3    PIN5,
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 10  

  40      =3    PIN6,
  41      =3    PIN7
  42      =3  }GpioPin;
  43      =3  
  44      =3  
  45      =3  /*< IO level defined. >*/
  46      =3  typedef  enum
  47      =3  {
  48      =3    IO_LOW = 0,
  49      =3    IO_HIGH,
  50      =3  }GpioLevel;
  51      =3  
  52      =3  
  53      =3  /*< IO mode defined. >*/
  54      =3  typedef  enum
  55      =3  {
  56      =3    QUASI_MODE,
  57      =3    PP_MODE,
  58      =3    INPUT_MODE,
  59      =3    OD_MODE,
  60      =3  }GpioMode;
  61      =3  
  62      =3  
  63      =3  /*< IO interrupt trig type defined. >*/
  64      =3  typedef  enum
  65      =3  {
  66      =3    LEVEL_TRIG,
  67      =3    EDGE_TRIG,
  68      =3  }GpioTrig;
  69      =3  
  70      =3  
  71      =3  /*< IO interrupt phase type defined. >*/
  72      =3  typedef  enum
  73      =3  {
  74      =3    RISING_H_TRIG,
  75      =3    FALLING_L_TRIG,
  76      =3  }GpioTrigPhase;
  77      =3  
  78      =3  
  79      =3  /*-- functions  ---------------------------------------------------------------*/
  80      =3  extern     void           mcu_gpio_set_all_default(void);
  81      =3  
  82      =3  extern     void           mcu_gpio_write(GpioPort port, GpioPin pin, \
  83      =3                                           GpioLevel level);
  84      =3  extern     GpioLevel      mcu_gpio_read(GpioPort port, GpioPin pin);
  85      =3  extern     void           mcu_gpio_set_mode(GpioPort port, GpioPin pin, \
  86      =3                                              GpioMode mode);
  87      =3  
  88      =3  
  89      =3  #endif   /* HAL_GPIO_H */
  90      =3  
  91      =3  /*---------------------- end of file -----------------------------------------*/
  23      =2  #include "./hal_uart.h"
   1      =3                                /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 11  

  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    HAL_UART_H
  14      =3  #define    HAL_UART_H
  15      =3  
  16      =3  
  17      =3  /*-- includes  ---------------------------------------------------------------*/
  18      =3  #include "../includes/_sys_config.h"
   1      =4  /**
   2      =4    ******************************************************************************
   3      =4    * @file    
   4      =4    * @author  
   5      =4    * @version 
   6      =4    * @date   
   7      =4    * @brief   
   8      =4    ******************************************************************************  
   9      =4    * 
  10      =4    * 
  11      =4    ******************************************************************************
  12      =4    */
  13      =4  #ifndef    _SYS_CONFIG_H
           =4 #define    _SYS_CONFIG_H
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 extern "C" {
           =4 #endif
           =4 
           =4 
           =4 #include "./_sys_std.h"
           =4 
           =4 
           =4 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =4 #define     WDT_ENABLE                                 1
           =4 
           =4 /*< Log output configuration. 0: disable; 1:enable. >*/
           =4 #define     LOG_ENABLE                                 1
           =4 
           =4 /*< Console configuration. 0: disable; 1:enable. >*/
           =4 #define     CONSOLE_ENABLE                             0
           =4 
           =4 
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 }
           =4 #endif
           =4 
           =4 
           =4 #endif   /* _SYS_CONFIG_H */
  45      =4  
  46      =4  /*---------------------- end of file -----------------------------------------*/
  19      =3  
  20      =3  
  21      =3  
  22      =3  /*-- defined  ----------------------------------------------------------------*/
  23      =3  typedef   void  (*Uart0tRxCallbackPt)(u8_t dat);
  24      =3  
  25      =3  
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 12  

  26      =3  /*-- functions  ---------------------------------------------------------------*/
  27      =3  extern   void   mcu_uart0_init(u32_t u32Baudrate);
  28      =3  extern   void   uart0_rx_callback_register(Uart0tRxCallbackPt  func);
  29      =3  
  30      =3  
  31      =3  #endif   /* HAL_UART_H */
  32      =3  
  33      =3  /*---------------------- end of file -----------------------------------------*/
  24      =2  #include "./hal_wtd.h"
   1      =3                                /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    HAL_WTD_H
  14      =3  #define    HAL_WTD_H
  15      =3  
  16      =3  
  17      =3  /*-- includes  ---------------------------------------------------------------*/
  18      =3  #include "../includes/_sys_config.h"
   1      =4  /**
   2      =4    ******************************************************************************
   3      =4    * @file    
   4      =4    * @author  
   5      =4    * @version 
   6      =4    * @date   
   7      =4    * @brief   
   8      =4    ******************************************************************************  
   9      =4    * 
  10      =4    * 
  11      =4    ******************************************************************************
  12      =4    */
  13      =4  #ifndef    _SYS_CONFIG_H
           =4 #define    _SYS_CONFIG_H
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 extern "C" {
           =4 #endif
           =4 
           =4 
           =4 #include "./_sys_std.h"
           =4 
           =4 
           =4 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =4 #define     WDT_ENABLE                                 1
           =4 
           =4 /*< Log output configuration. 0: disable; 1:enable. >*/
           =4 #define     LOG_ENABLE                                 1
           =4 
           =4 /*< Console configuration. 0: disable; 1:enable. >*/
           =4 #define     CONSOLE_ENABLE                             0
           =4 
           =4 
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 13  

           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 }
           =4 #endif
           =4 
           =4 
           =4 #endif   /* _SYS_CONFIG_H */
  45      =4  
  46      =4  /*---------------------- end of file -----------------------------------------*/
  19      =3  
  20      =3  
  21      =3  
  22      =3  /*-- defined  ----------------------------------------------------------------*/
  23      =3  
  24      =3  
  25      =3  
  26      =3  /*-- functions  ---------------------------------------------------------------*/
  27      =3  extern     void           mcu_wdt_start(void);
  28      =3  extern     void           mcu_wdt_feed(void);
  29      =3  
  30      =3  
  31      =3  #endif   /* HAL_WTD_H */
  32      =3  
  33      =3  /*---------------------- end of file -----------------------------------------*/
  25      =2  #include "./hal_timer.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    HAL_TIMER_H
  14      =3  #define    HAL_TIMER_H
  15      =3  
  16      =3  
  17      =3  /*-- includes  ---------------------------------------------------------------*/
  18      =3  #include "../includes/_sys_config.h"
   1      =4  /**
   2      =4    ******************************************************************************
   3      =4    * @file    
   4      =4    * @author  
   5      =4    * @version 
   6      =4    * @date   
   7      =4    * @brief   
   8      =4    ******************************************************************************  
   9      =4    * 
  10      =4    * 
  11      =4    ******************************************************************************
  12      =4    */
  13      =4  #ifndef    _SYS_CONFIG_H
           =4 #define    _SYS_CONFIG_H
           =4 
           =4 
           =4 /* C++ support */
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 14  

           =4 #ifdef __cplusplus
           =4 extern "C" {
           =4 #endif
           =4 
           =4 
           =4 #include "./_sys_std.h"
           =4 
           =4 
           =4 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =4 #define     WDT_ENABLE                                 1
           =4 
           =4 /*< Log output configuration. 0: disable; 1:enable. >*/
           =4 #define     LOG_ENABLE                                 1
           =4 
           =4 /*< Console configuration. 0: disable; 1:enable. >*/
           =4 #define     CONSOLE_ENABLE                             0
           =4 
           =4 
           =4 
           =4 
           =4 /* C++ support */
           =4 #ifdef __cplusplus
           =4 }
           =4 #endif
           =4 
           =4 
           =4 #endif   /* _SYS_CONFIG_H */
  45      =4  
  46      =4  /*---------------------- end of file -----------------------------------------*/
  19      =3  
  20      =3  
  21      =3  
  22      =3  /*-- defined  ----------------------------------------------------------------*/
  23      =3  typedef  enum
  24      =3  {
  25      =3    TIMER0,
  26      =3    TIMER1,
  27      =3    TIMER2,
  28      =3    TIMER3,
  29      =3  }HwTrDef;
  30      =3  
  31      =3  
  32      =3  /*-- functions  ---------------------------------------------------------------*/
  33      =3  extern   void   hal_timer_disable_interrupt(HwTrDef tr);
  34      =3  extern   void   hal_timer_stop(HwTrDef tr);
  35      =3  
  36      =3  
  37      =3  #endif   /* HAL_TIMER_H */
  38      =3  
  39      =3  /*---------------------- end of file -----------------------------------------*/
  26      =2  
  27      =2  /*-- defined  ----------------------------------------------------------------*/
  28      =2  
  29      =2  
  30      =2  
  31      =2  
  32      =2  
  33      =2  /*-- functions  ---------------------------------------------------------------*/
  34      =2  extern     void           mcu_reset(void);
  35      =2  extern     void           mcu_power_down(void);
  36      =2  
  37      =2  
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 15  

  38      =2  
  39      =2  
  40      =2  #endif   /* HAL_CORE_H */
  41      =2  
  42      =2  /*---------------------- end of file -----------------------------------------*/
  22      =1  
  23      =1  #include "../common/task_def.h"
   1      =2  /**
   2      =2    ******************************************************************************
   3      =2    * @file    
   4      =2    * @author  
   5      =2    * @version 
   6      =2    * @date   
   7      =2    * @brief   os_switch_task()   
   8      =2                --When TIMESHARING=0, it must call this function to switch task.
   9      =2    ******************************************************************************  
  10      =2    * 
  11      =2    * 
  12      =2    ******************************************************************************
  13      =2    */
  14      =2  #ifndef    TASK_DEF_H
  15      =2  #define    TASK_DEF_H
  16      =2  
  17      =2  
  18      =2  /*-- includes  ---------------------------------------------------------------*/
  19      =2  #include "../includes/_sys_config.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef    _SYS_CONFIG_H
           =3 #define    _SYS_CONFIG_H
           =3 
           =3 
           =3 /* C++ support */
           =3 #ifdef __cplusplus
           =3 extern "C" {
           =3 #endif
           =3 
           =3 
           =3 #include "./_sys_std.h"
           =3 
           =3 
           =3 /*< Configure the watchdog function.  0: disable; 1:enable. >*/
           =3 #define     WDT_ENABLE                                 1
           =3 
           =3 /*< Log output configuration. 0: disable; 1:enable. >*/
           =3 #define     LOG_ENABLE                                 1
           =3 
           =3 /*< Console configuration. 0: disable; 1:enable. >*/
           =3 #define     CONSOLE_ENABLE                             0
           =3 
           =3 
           =3 
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 16  

           =3 
           =3 /* C++ support */
           =3 #ifdef __cplusplus
           =3 }
           =3 #endif
           =3 
           =3 
           =3 #endif   /* _SYS_CONFIG_H */
  45      =3  
  46      =3  /*---------------------- end of file -----------------------------------------*/
  20      =2  
  21      =2  #include <rtx51tny.h>
   1      =3  /*--------------------------------------------------------------------------
   2      =3  RTX51TNY.H
   3      =3  
   4      =3  Prototypes for RTX51 Tiny Real-Time Operating System Version 2.02
   5      =3  Copyright (c) 1988-2002 Keil Elektronik GmbH and Keil Software, Inc.
   6      =3  All rights reserved.
   7      =3  --------------------------------------------------------------------------*/
   8      =3  
   9      =3  #ifndef __RTX51TNY_H__
  10      =3  #define __RTX51TNY_H__
  11      =3  
  12      =3  
  13      =3  /* constants for os_wait function */
  14      =3  #define K_SIG      0x01              /* Wait for Signal   */
  15      =3  #define K_TMO      0x02              /* Wait for Timeout  */
  16      =3  #define K_IVL      0x80              /* Wait for Interval */
  17      =3  
  18      =3  /* function return values */
  19      =3  #define NOT_OK     0xFF              /* Parameter Error */
  20      =3  #define TMO_EVENT  0x08              /* Timeout Event   */
  21      =3  #define SIG_EVENT  0x04              /* Signal  Event   */
  22      =3  #define RDY_EVENT  0x80              /* Ready   Event   */
  23      =3  
  24      =3  extern unsigned char os_create_task     (unsigned char task_id);
  25      =3  extern unsigned char os_delete_task     (unsigned char task_id);
  26      =3  
  27      =3  extern unsigned char os_wait            (unsigned char typ, 
  28      =3                                           unsigned char ticks,
  29      =3                                           unsigned int dummy);
  30      =3  extern unsigned char os_wait1           (unsigned char typ);
  31      =3  extern unsigned char os_wait2           (unsigned char typ,
  32      =3                                           unsigned char ticks);
  33      =3  
  34      =3  extern unsigned char os_send_signal     (unsigned char task_id);
  35      =3  extern unsigned char os_clear_signal    (unsigned char task_id);
  36      =3  extern unsigned char isr_send_signal    (unsigned char task_id);
  37      =3  
  38      =3  extern void          os_set_ready       (unsigned char task_id);
  39      =3  extern void          isr_set_ready      (unsigned char task_id);
  40      =3  
  41      =3  extern unsigned char os_running_task_id (void);
  42      =3  extern unsigned char os_switch_task     (void); 
  43      =3  
  44      =3  extern void          os_reset_interval  (unsigned char ticks);
  45      =3  
  46      =3  #endif
  22      =2  
  23      =2  
  24      =2  /*-- defined  ----------------------------------------------------------------*/
  25      =2  /*< User defined. >*/
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 17  

  26      =2  #define      GET_SYS_TICK()                   get_systick()
  27      =2  
  28      =2  
  29      =2  
  30      =2  /*< Task run period. >*/
  31      =2  #define      TASK_PERIOD                      TIMESHARING
  32      =2  
  33      =2  
  34      =2  
  35      =2  /*< Task timer defined. >*/
  36      =2  #define      TASK_TIMER_BEGIN(tick, period)                                    \
  37      =2               do{                                                               \
  38      =2                   if((GET_SYS_TICK()-tick) >= period)                           \
  39      =2                   {                                                             \
  40      =2                     tick = GET_SYS_TICK();                                       
  41      =2  
  42      =2  #define      TASK_TIMER_END(tick)                                              \ 
  43      =2                   }                                                             \                
  44      =2               }while(0)
  45      =2  
  46      =2  
  47      =2  
  48      =2  
  49      =2  
  50      =2  #endif   /* MAIN_H */
  51      =2  
  52      =2  /*---------------------- end of file -----------------------------------------*/
  24      =1  #include "../common/ring_buffer.h"
   1      =2  /**
   2      =2    ******************************************************************************
   3      =2    * @file    
   4      =2    * @author  
   5      =2    * @version 
   6      =2    * @date   
   7      =2    * @brief   
   8      =2    ******************************************************************************  
   9      =2    * 
  10      =2    * 
  11      =2    ******************************************************************************
  12      =2    */
  13      =2  #ifndef  RING_BUFFER_H
  14      =2  #define  RING_BUFFER_H
  15      =2  
  16      =2  /*-- includes ----------------------------------------------------------------*/
  17      =2  #include "../includes/_sys_std.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef  _SYS_STD_H
           =3 #define  _SYS_STD_H
           =3 
           =3 
           =3 /* C++支持 */
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 18  

           =3 #ifdef __cplusplus
           =3 extern "C" {
           =3 #endif
           =3  
           =3 
           =3 
           =3 /*!< Signed integer types  */
           =3 typedef         signed char             s8_t;
           =3 typedef         signed int              s16_t;
           =3 typedef         signed long             s32_t;
           =3 
           =3 /*!< Unsigned integer types  */
           =3 typedef         unsigned char           u8_t;
           =3 typedef         unsigned int            u16_t;
           =3 typedef         unsigned long           u32_t;
           =3 
           =3 
           =3 
           =3 #define       XDATA    xdata
           =3 #define       IDATA    idata
           =3 #define       BDATA    bdata
           =3 #define       DATA     data
           =3 #define       CODE     code
           =3 
           =3 
           =3 /* 把宏参数变为一个字符串 */
           =3 #define     _STRING(x)                  #x
           =3 #define     STRING(x)                   _STRING(x)
           =3 
           =3 /* 把宏参数连接在一起 */
           =3 #define     _CONNECT_MACRO(x,y)         x##y
           =3 #define     CONNECT_MACRO(x,y)          _CONNECT_MACRO(x,y)
           =3 
           =3 
           =3 
           =3 /* 状态类型 */
           =3 typedef  enum
           =3 {
           =3   OPERATE_OK  = 0,
           =3   OPERATE_BUSY,
           =3   OPERATE_TIMEOUT,
           =3   OPERATE_FAIL,
           =3 }OpsStatus;
           =3 
           =3 
           =3 #ifndef  _IN_LINE_
           =3   #define  _IN_LINE_   inline
           =3 #endif
           =3 
           =3 #ifndef   BOOL
           =3   #define   BOOL      bool
           =3 #endif
           =3 
           =3 #ifndef   NULL
           =3   #define   NULL     (void*)0
           =3 #endif
           =3 
           =3 
           =3 #ifndef  TRUE
           =3   #define   TRUE    1
           =3 #endif
           =3 
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 19  

           =3 #ifndef  FALSE
           =3   #define   FALSE    0
           =3 #endif
           =3 
           =3 /* 纯虚函数关键字 */
           =3 #ifndef   VIRTUAL
           =3   #define   VIRTUAL
           =3 #endif
           =3 
           =3 
           =3 
           =3 
           =3 #ifdef __cplusplus
           =3 }
           =3 #endif
           =3 
           =3 #endif    /* _SYS_STD_H */
  97      =3  
  98      =3  /*------------------ end of file ---------------------------------------------*/
  18      =2  
  19      =2  
  20      =2  /*-- defined -----------------------------------------------------------------*/
  21      =2  
  22      =2  
  23      =2  
  24      =2  
  25      =2  /*-- typedef -----------------------------------------------------------------*/
  26      =2  typedef    u8_t     rb_depth_t;
  27      =2  typedef    u8_t     rb_data_type;
  28      =2  
  29      =2  
  30      =2  //struct  RingBuffStruct;
  31      =2  
  32      =2  struct  RingBuffStruct  
  33      =2  {
  34      =2    rb_depth_t      posPut;    /* The current location of the ring buffer. */
  35      =2    rb_depth_t      posGet;    /* The current fetch position of the buffer. */
  36      =2    rb_depth_t      depth;     /* The total number of elements in the ring buffer. */
  37      =2    rb_depth_t      remain;
  38      =2    
  39      =2    rb_data_type*   ptBuffer;  /* Ring buffer pointer. */
  40      =2  };
  41      =2  
  42      =2  typedef  struct  RingBuffStruct  RingBuffObj;
  43      =2  
  44      =2  
  45      =2  /*-- functions ---------------------------------------------------------------*/
  46      =2  extern    void            ring_buff_create(RingBuffObj* obj, rb_depth_t depth, \
  47      =2                                             rb_data_type* ptBuffer);
  48      =2  extern    rb_depth_t      check_ring_buff(RingBuffObj* thiz);
  49      =2  extern    rb_data_type    get_ring_buff_data(RingBuffObj* thiz);
  50      =2  extern    void            put_ring_buff_data(RingBuffObj* thiz, rb_data_type dat);
  51      =2  
  52      =2  
  53      =2  #endif    /* RING_BUFFER_H */
  54      =2  
  55      =2  /*------------------ end of file ---------------------------------------------*/
  25      =1  #include "../common/msg.h"
   1      =2  /**
   2      =2    ******************************************************************************
   3      =2    * @file    
   4      =2    * @author  
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 20  

   5      =2    * @version 
   6      =2    * @date   
   7      =2    * @brief   
   8      =2    ******************************************************************************  
   9      =2    * 
  10      =2    * 
  11      =2    ******************************************************************************
  12      =2    */
  13      =2  #ifndef  MSG_H
  14      =2  #define  MSG_H
  15      =2  
  16      =2  /*-- includes ----------------------------------------------------------------*/
  17      =2  #include "../includes/_sys_std.h"
   1      =3  /**
   2      =3    ******************************************************************************
   3      =3    * @file    
   4      =3    * @author  
   5      =3    * @version 
   6      =3    * @date   
   7      =3    * @brief   
   8      =3    ******************************************************************************  
   9      =3    * 
  10      =3    * 
  11      =3    ******************************************************************************
  12      =3    */
  13      =3  #ifndef  _SYS_STD_H
           =3 #define  _SYS_STD_H
           =3 
           =3 
           =3 /* C++支持 */
           =3 #ifdef __cplusplus
           =3 extern "C" {
           =3 #endif
           =3  
           =3 
           =3 
           =3 /*!< Signed integer types  */
           =3 typedef         signed char             s8_t;
           =3 typedef         signed int              s16_t;
           =3 typedef         signed long             s32_t;
           =3 
           =3 /*!< Unsigned integer types  */
           =3 typedef         unsigned char           u8_t;
           =3 typedef         unsigned int            u16_t;
           =3 typedef         unsigned long           u32_t;
           =3 
           =3 
           =3 
           =3 #define       XDATA    xdata
           =3 #define       IDATA    idata
           =3 #define       BDATA    bdata
           =3 #define       DATA     data
           =3 #define       CODE     code
           =3 
           =3 
           =3 /* 把宏参数变为一个字符串 */
           =3 #define     _STRING(x)                  #x
           =3 #define     STRING(x)                   _STRING(x)
           =3 
           =3 /* 把宏参数连接在一起 */
           =3 #define     _CONNECT_MACRO(x,y)         x##y
           =3 #define     CONNECT_MACRO(x,y)          _CONNECT_MACRO(x,y)
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 21  

           =3 
           =3 
           =3 
           =3 /* 状态类型 */
           =3 typedef  enum
           =3 {
           =3   OPERATE_OK  = 0,
           =3   OPERATE_BUSY,
           =3   OPERATE_TIMEOUT,
           =3   OPERATE_FAIL,
           =3 }OpsStatus;
           =3 
           =3 
           =3 #ifndef  _IN_LINE_
           =3   #define  _IN_LINE_   inline
           =3 #endif
           =3 
           =3 #ifndef   BOOL
           =3   #define   BOOL      bool
           =3 #endif
           =3 
           =3 #ifndef   NULL
           =3   #define   NULL     (void*)0
           =3 #endif
           =3 
           =3 
           =3 #ifndef  TRUE
           =3   #define   TRUE    1
           =3 #endif
           =3 
           =3 #ifndef  FALSE
           =3   #define   FALSE    0
           =3 #endif
           =3 
           =3 /* 纯虚函数关键字 */
           =3 #ifndef   VIRTUAL
           =3   #define   VIRTUAL
           =3 #endif
           =3 
           =3 
           =3 
           =3 
           =3 #ifdef __cplusplus
           =3 }
           =3 #endif
           =3 
           =3 #endif    /* _SYS_STD_H */
  97      =3  
  98      =3  /*------------------ end of file ---------------------------------------------*/
  18      =2  
  19      =2  
  20      =2  /*-- defined -----------------------------------------------------------------*/
  21      =2  
  22      =2  
  23      =2  typedef   u8_t   msg_size_t;
  24      =2  typedef   u8_t   msg_len_t;
  25      =2  
  26      =2  typedef  enum
  27      =2  {
  28      =2    MSG_MIS_MATCH,
  29      =2    MSG_MATCH,
  30      =2  }MsgMatch;
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 22  

  31      =2  
  32      =2  typedef  struct
  33      =2  {
  34      =2    msg_len_t     len;
  35      =2    msg_size_t*   array;  
  36      =2  }MsgDef;
  37      =2  
  38      =2  #define          NO_MSG_DEF     (msg_size_t)0
  39      =2  
  40      =2  /*-- functions ---------------------------------------------------------------*/
  41      =2  extern s8_t        msg_create(MsgDef* obj, msg_size_t* array, msg_len_t len);
  42      =2  
  43      =2  extern void        msg_broadcast(MsgDef* obj, msg_size_t msg);  
  44      =2                                    
  45      =2  extern MsgMatch    msg_check(MsgDef* obj, msg_len_t index, msg_size_t msg);
  46      =2  
  47      =2  
  48      =2  
  49      =2  #endif    /* MSG_H */
  50      =2  
  51      =2  /*------------------ end of file ---------------------------------------------*/
  26      =1  
  27      =1  
  28      =1  
  29      =1  /*-- defined  ----------------------------------------------------------------*/
  30      =1  typedef      u8_t                             tick_size_t;
  31      =1  
  32      =1  
  33      =1  #define      SYSTEM_TASK_PRIORITY             0
  34      =1  #define      BUTTON_TASK_PRIORITY             1
  35      =1  #define      LED_TASK_PRIORITY                2
  36      =1  #define      BMS_TASK_PRIORITY                3
  37      =1  #define      CONSOLE_TASK_PRIORITY            4
  38      =1  
  39      =1  
  40      =1  typedef  enum
  41      =1  {
  42      =1    SYS_RESET         = (msg_size_t)1,
  43      =1    SYS_POWER_DOWN    = (msg_size_t)2,
  44      =1    SYS_IDLE          = (msg_size_t)3,
  45      =1    SYS_SLEEP         = (msg_size_t)4,
  46      =1  }SysMsgType;
  47      =1  
  48      =1  
  49      =1  /*< Log configuration. >*/
  50      =1  /** 
  51      =1    %bd              十进制有符号整数(signed char)
  52      =1    %bu              十进制无符号整数(unsigned char)
  53      =1    %lu              十进制无符号整数(unsigned long)
  54      =1    %f               浮点数
  55      =1    %s               字符串
  56      =1    %c               单个字符
  57      =1    %p               指针的值
  58      =1    %e               指数形式的浮点数
  59      =1    %x, %X           无符号以十六进制表示的整数
  60      =1    %0               无符号以八进制表示的整数
  61      =1    %g               自动选择合适的表示法
  62      =1    %lf              表示输出double浮点数
  63      =1    */
  64      =1  #if   LOG_ENABLE
  65      =1    #define         LOG              printf 
  66      =1  #else 
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 23  

           =1   #define         LOG 
           =1 #endif 
  69      =1  
  70      =1  
  71      =1  
  72      =1  /*-- functions  ---------------------------------------------------------------*/
  73      =1  extern     tick_size_t    get_systick(void);
  74      =1  extern     MsgDef*        get_system_broadcast_handle(void);
  75      =1  
  76      =1  extern     void           system_power_on(void);
  77      =1  extern     void           system_power_off(void);
  78      =1  
  79      =1  
  80      =1  #endif   /* SYSTEM_H */
  81      =1  
  82      =1  /*---------------------- end of file -----------------------------------------*/
  15          
  16          
  17          
  18          
  19          /*-- defined -----------------------------------------------------------------*/
  20          #define      TIME_MS(x)                 (x)
  21          
  22          #define      SYS_POWER_PORT             PORT0
  23          #define      SYS_POWER_PIN              PIN3
  24          #define      SYS_POWER_MODE             PP_MODE
  25          
  26          
  27          /*-- private variables -------------------------------------------------------*/
  28          
  29          static  volatile   tick_size_t DATA _sysTickCnt = 0;
  30          
  31          static   tick_size_t XDATA systemTaskBaseTr = 0; 
  32          
  33          
  34          #define  SYS_BROADCAST_TASK_LEN   15
  35          static   msg_size_t  XDATA   sysBroadcastTask[SYS_BROADCAST_TASK_LEN];
  36          static   MsgDef      XDATA   sysBroadcastMsg;
  37          
  38          /*-- functions ---------------------------------------------------------------*/
  39          
  40          static    void    system_task_timer_schedule(void);
  41          static    void    system_task_logic_schedule(void);
  42          
  43          
  44          
  45          
  46          /**           
  47            * @brief            
  48            * @param    
  49            * @return  
  50            * @note
  51            */
  52          void   _systick_increase(void)
  53          {
  54   1        _sysTickCnt++;
  55   1      }
  56          
  57          
  58          /**           
  59            * @brief            
  60            * @param    
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 24  

  61            * @return  
  62            * @note
  63            */
  64          u8_t   get_systick(void)
  65          {
  66   1        return  _sysTickCnt;
  67   1      }
  68          
  69          
  70          /**           
  71            * @brief            
  72            * @param    
  73            * @return  
  74            * @note
  75            */
  76          MsgDef*  get_system_broadcast_handle(void)
  77          {
  78   1        return &sysBroadcastMsg;
  79   1      }
  80          
  81          /**           
  82            * @brief            
  83            * @param    
  84            * @return  
  85            * @note
  86            */
  87          void  system_power_on(void)
  88          {
  89   1        mcu_gpio_write(SYS_POWER_PORT, SYS_POWER_PIN, IO_HIGH);
  90   1      }
  91          
  92          /**           
  93            * @brief            
  94            * @param    
  95            * @return  
  96            * @note
  97            */
  98          void  system_power_off(void)
  99          {
 100   1        mcu_gpio_write(SYS_POWER_PORT, SYS_POWER_PIN, IO_LOW);
 101   1      }
 102          
 103          /**           
 104            * @brief            
 105            * @param    
 106            * @return  
 107            * @note
 108            */ 
 109          static  void  system_task_timer_schedule(void)
 110          {
 111   1        TASK_TIMER_BEGIN(systemTaskBaseTr, TIME_MS(100));
 112   3      
 113   3      
 114   3        TASK_TIMER_END(systemTaskBaseTr);
 115   1      }
 116          
 117          
 118          /**           
 119            * @brief            
 120            * @param    
 121            * @return  
 122            * @note
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 25  

 123            */
 124          static  void  system_task_logic_schedule(void)
 125          {    
 126   1        XDATA MsgDef* msgHandle;
 127   1      
 128   1        mcu_wdt_feed();
 129   1      
 130   1        msgHandle = get_system_broadcast_handle();
 131   1        
 132   1        if(msg_check(msgHandle, SYSTEM_TASK_PRIORITY, SYS_RESET) == MSG_MATCH)
 133   1        {
 134   2          //LOG("[SYS]reset anser\r\n");
 135   2        } 
 136   1        
 137   1        if(msg_check(msgHandle, SYSTEM_TASK_PRIORITY, SYS_SLEEP) == MSG_MATCH)
 138   1        {
 139   2          //LOG("[SYS]sleep anser\r\n");
 140   2        } 
 141   1      
 142   1         
 143   1      }
 144          
 145          /**           
 146            * @brief            
 147            * @param    
 148            * @return  
 149            * @note
 150            */
 151          void  system_task (void)  _task_   SYSTEM_TASK_PRIORITY
 152          {
 153   1        mcu_clk_init(0);
 154   1        mcu_gpio_set_all_default();
 155   1        mcu_gpio_set_mode(SYS_POWER_PORT, SYS_POWER_PIN, SYS_POWER_MODE);
 156   1      
 157   1      #if     LOG_ENABLE
 158   1        mcu_uart0_init(115200);
 159   1      #endif
 160   1        
 161   1        mcu_wdt_start();
 162   1        mcu_wdt_feed();
 163   1      
 164   1        /* Create user task. */
 165   1        os_create_task(BUTTON_TASK_PRIORITY);
 166   1        os_create_task(LED_TASK_PRIORITY);
 167   1        os_create_task(BMS_TASK_PRIORITY);
 168   1      
 169   1      #if  CONSOLE_ENABLE
                os_create_task(CONSOLE_TASK_PRIORITY);
              #endif
 172   1      
 173   1        system_power_on();
 174   1      
 175   1        /* Task message queue create. */
 176   1        msg_create(&sysBroadcastMsg, sysBroadcastTask, SYS_BROADCAST_TASK_LEN);
 177   1      
 178   1        /* System task run. */
 179   1        while(1)
 180   1        {
 181   2          system_task_timer_schedule();
 182   2          system_task_logic_schedule();
 183   2      
 184   2          os_switch_task();
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 26  

 185   2        }
 186   1      }
 187          
 188          
 189          
 190          
 191          
 192          /*---------------------- end of file -----------------------------------------*/
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 27  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


SYS_IDLE . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
s8_t . . . . . . . . . . . . . . . . .  TYPEDEF  -----  CHAR     -----  1
MSG_MIS_MATCH. . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
u8_t . . . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
systemTaskBaseTr . . . . . . . . . . .  STATIC   XDATA  U_CHAR   0000H  1
SYS_POWER_DOWN . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
mcu_wdt_start. . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
QUASI_MODE . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
GpioLevel. . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
OPERATE_OK . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
SysMsgType . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
_mcu_gpio_set_mode . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
RISING_H_TRIG. . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
sysBroadcastTask . . . . . . . . . . .  STATIC   XDATA  ARRAY    0001H  15
OPERATE_FAIL . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
LEVEL_TRIG . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
size_t . . . . . . . . . . . . . . . .  TYPEDEF  -----  U_INT    -----  2
HwTrDef. . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
PIN0 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
MsgMatch . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
GpioMode . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
INPUT_MODE . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PIN1 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_BANDGAP. . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
OD_MODE. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
IO_HIGH. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PIN2 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PIN3 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PIN4 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PIN5 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PIN6 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
OPERATE_TIMEOUT. . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
_systick_increase. . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
GpioTrigPhase. . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
PIN7 . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
tick_size_t. . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
_msg_create. . . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
RingBuffStruct . . . . . . . . . . . .  * TAG *  -----  STRUCT   -----  7
  posPut . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  posGet . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  depth. . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0002H  1
  remain . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0003H  1
  ptBuffer . . . . . . . . . . . . . .  MEMBER   -----  PTR      0004H  3
rb_depth_t . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
sysBroadcastMsg. . . . . . . . . . . .  STATIC   XDATA  STRUCT   0010H  4
PP_MODE. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
_msg_check . . . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
GpioTrig . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
_mcu_uart0_init. . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
s32_t. . . . . . . . . . . . . . . . .  TYPEDEF  -----  LONG     -----  4
EDGE_TRIG. . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
u32_t. . . . . . . . . . . . . . . . .  TYPEDEF  -----  U_LONG   -----  4
s16_t. . . . . . . . . . . . . . . . .  TYPEDEF  -----  INT      -----  2
get_systick. . . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
u16_t. . . . . . . . . . . . . . . . .  TYPEDEF  -----  U_INT    -----  2
TIMER0 . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
TIMER1 . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 28  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


RingBuffObj. . . . . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  7
  posPut . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  posGet . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  depth. . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0002H  1
  remain . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0003H  1
  ptBuffer . . . . . . . . . . . . . .  MEMBER   -----  PTR      0004H  3
TIMER2 . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
get_system_broadcast_handle. . . . . .  PUBLIC   CODE   PROC     0000H  -----
TIMER3 . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
MSG_MATCH. . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
OPERATE_BUSY . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
MsgDef . . . . . . . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  4
  len. . . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  array. . . . . . . . . . . . . . . .  MEMBER   -----  PTR      0001H  3
GpioPort . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
GpioPin. . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
msg_size_t . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
OpsStatus. . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
msg_len_t. . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
system_task. . . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
FALLING_L_TRIG . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
_os_create_task. . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
system_power_off . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
SYS_SLEEP. . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
AdcChannelEnum . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
system_task_logic_schedule . . . . . .  STATIC   CODE   PROC     0000H  -----
  msgHandle. . . . . . . . . . . . . .  AUTO     XDATA  PTR      0000H  3
ADC_CH0. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
SYS_RESET. . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_CH1. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_CH2. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
Uart0tRxCallbackPt . . . . . . . . . .  TYPEDEF  -----  PTR      -----  3
_mcu_gpio_write. . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
ADC_CH3. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_CH4. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_CH5. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_CH6. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
IO_LOW . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
ADC_CH7. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
mcu_gpio_set_all_default . . . . . . .  EXTERN   CODE   PROC     -----  -----
mcu_wdt_feed . . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
os_switch_task . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
_sysTickCnt. . . . . . . . . . . . . .  STATIC   DATA   U_CHAR   0000H  1
rb_data_type . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
PORT0. . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
system_task_timer_schedule . . . . . .  STATIC   CODE   PROC     0000H  -----
PORT1. . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
system_power_on. . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
PORT2. . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
PORT3. . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
_mcu_clk_init. . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    199    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     20       3
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.00   SYSTEM                                                                06/17/2020 12:01:31 PAGE 29  

   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
